/*! api 2015-08-15 */
var express=require("express");var mongoose=require("mongoose");var bodyParser=require("body-parser");var fs=require("fs");var needle=require("needle");var moment=require("moment");var app=express();var docs=require("express-mongoose-docs");app.use(express.static(__dirname+"/"));app.use(express.static(__dirname+"/apidoc"));app.use(express.static(__dirname+"/../../src"));var multipart=require("connect-multiparty");var multipartMiddleware=multipart();var flow=require("./flow-node.js")("tmp");var ACCESS_CONTROLL_ALLOW_ORIGIN=false;app.use(bodyParser.json());docs(app,mongoose);function log(a){console.log("["+Date.now()+"] API CALL: "+a)}app.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*");b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");b.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE");c()});app.get("/api",function(a,b){b.send("Cityfab API is live and running. Please goto http://"+server.address().address+":"+server.address().port+"/apidoc/ to read proper usage documentation")});mongoose.connect("mongodb://bedbug:a21th21@ds059131-a0.mongolab.com:59131,ds059131-a1.mongolab.com:59131/cityfab");var comment=new mongoose.Schema({name:{type:String,required:true},comment:{type:String,required:false},createdAt:{type:String}});var CommentModel=mongoose.model("comments",comment);var subservice=new mongoose.Schema({service:{type:String,required:false},subservicename:{type:String,required:false},price:{type:Number,required:false}});var SubServiceModel=mongoose.model("subservices",subservice);var miniUser=new mongoose.Schema({id:{type:String,required:true},name:{type:String,required:true},token:{type:String,required:false}});var miniUserModel=mongoose.model("miniUser",miniUser);var invoice=new mongoose.Schema({sid:{type:String,required:false},invoiceid:{type:String,required:false},invoicedate:{type:Date,required:false},itemname:{type:String},sum:{type:Number,required:false}});var InvoiceModel=mongoose.model("invoices",invoice);var workDate=new mongoose.Schema({workday:{type:Date,required:false},wdid:{type:String,required:true},timeslots:{type:[String],required:false},owner:{type:mongoose.Schema.Types.ObjectId,ref:"Users"}});var workDateModel=mongoose.model("workdates",workDate);var AppointmentsSchema=mongoose.Schema;var Appointment=new AppointmentsSchema({upic:{type:String,required:false},uname:{type:String,required:false},uid:{type:String},utoken:{type:String,required:false},spic:{type:String,required:false},sname:{type:String,required:false},sid:{type:String},stoken:{type:String,required:false},calltype:{type:String},address:{type:String,required:false},subservicetype:{type:String,required:false},timetable:{type:[workDate],required:true},comments:{type:[comment],required:false},status:{type:String,required:true},startdate:{type:Date},rated:{type:Boolean},notified:{type:Boolean},requestedon:{type:Date},cost:{type:Number},distance:{type:Number}});var AppointmentsModel=mongoose.model("Appointments",Appointment);var RateSchema=mongoose.Schema;var RateObject=new RateSchema({sname:{type:String,required:false},pic:{type:String,required:false},sid:{type:String,required:false},stoken:{type:String,required:false},uname:{type:String,required:false},rating:{type:Number,required:false},review:{type:String}});var RateModel=mongoose.model("Ratings",RateObject);var AddressSchema=mongoose.Schema;var AddressObject=new AddressSchema({alias:{type:String,required:false},location:{type:String,required:false},geolocation:{type:[Number],required:false}});var AddressModel=mongoose.model("Addresses",AddressObject);var ScheduleSchema=mongoose.Schema;var schedule=new ScheduleSchema({days:{type:[String],required:false},timeblocks:{type:[String],required:false}});var Schedule=mongoose.model("Schedules",schedule);var WorkScheduleSchema=mongoose.Schema;var workSchedule=new WorkScheduleSchema({day:String,timeblocks:[String]});var userFullSchema=mongoose.Schema;var userFull=new userFullSchema({password:{type:String,required:true},firstname:{type:String,required:true},lastname:{type:String,required:true},usertype:{type:String,required:true},subscriptionstatus:{type:String},subscriptionends:{type:Date},calltype:{type:String},addresses:{type:[AddressObject],required:false},address:{type:String,required:false},mood:{type:String,required:false},aboutme:{type:String,required:false},services:{type:[String],required:false},schedule:{type:[schedule],required:false},workschedule:mongoose.Schema.Types.Mixed,languages:{type:[String],required:false},products:{type:[String],required:false},subservices:{type:[subservice],required:false},email:{type:String,required:true,unique:true},phone:{type:String,required:false},taxid:{type:String},pushtoken:{type:String,required:false},googleid:{type:String,required:false},fbid:{type:String,required:false},servicesnum:{type:Number},rating:{type:Number},reviews:{type:[RateObject],required:false},loc:{type:[Number],index:"2dsphere"},currentloc:{type:[Number],index:"2dsphere"},verified:{type:Boolean,required:true},profilepic:{type:String,required:false},profilethumb:{type:String,required:false},background:{type:String,required:false},gallery:{type:[String],required:false},torate:{type:[RateObject],required:false},availablenow:{type:Boolean},created:{type:Date,"default":Date.now},favorites:[mongoose.Schema.Types.Mixed],balance:mongoose.Schema.Types.Mixed});var User=mongoose.model("Users",userFull);var NotificationSchema=mongoose.Schema;var notification=new NotificationSchema({index:{type:Number,required:false},sender:{type:String,required:false},uid:{type:String,required:false},message:{type:String,required:false},localisedMessage:mongoose.Schema.Types.Mixed,data:mongoose.Schema.Types.Mixed,createdAt:{type:Date,expireAt:"72h"}});var Notification=mongoose.model("Notifications",notification);app.get("/apidoc",function(a,b){return b.render("apidoc/index.html")});app.post("/api/authenticate",function(a,b){console.log("email:"+a.body.email);User.findOne({email:a.body.email,password:a.body.password},function(a,c){if(!a){if(c!=null){console.log("[info] User found");return b.status(200).send(c)}else{console.log("[info] Authentication failed");return b.status(401).send("Authentication failed")}}else{return b.send(a)}})});app.get("/api/authenticate/id/:id",function(a,b){return User.findById(a.params.id,function(a,c){if(!a){if(c!=null)return b.send(c);else return b.status(501).send("No user with this ID")}else{console.log(a);return b.status(501).send(a)}})});app.get("/api/authenticate/email/:email",function(a,b){console.log("email:"+a.params.email);return User.findOne({email:a.params.email},function(a,c){if(!a){if(c){return b.status(401).send(c)}else{return b.status(200).send(c)}}else{console.log(a);return b.status(401).send(a)}})});app.get("/api/notifications/:id",function(a,b){return Notification.find({uid:a.params.id},{},{sort:{createdAt:-1}},function(a,c){if(!a){return b.send(c)}else{console.log(a);return b.status(501).send(a)}})});app.get("/api/payments/:id",function(a,b){return InvoiceModel.find({sid:a.params.id},{},{sort:{invoicedate:-1}},function(a,c){if(!a){return b.send(c)}else{console.log(a);return b.status(501).send(a)}})});var querystring=require("querystring");app.use("/api/paypal_listener",bodyParser.urlencoded({extended:true}));app.post("/api/paypal_listener",function(a,b){console.log("Received POST /");a.body=a.body||{};b.send(200,"OK");b.end();var c="cmd=_notify-validate";for(var d in a.body){if(a.body.hasOwnProperty(d)){var e=querystring.escape(a.body[d]);c=c+"&"+d+"="+e}}console.log("Posting back to paypal");var f={method:"POST",headers:{Connection:"close"},body:c,strictSSL:true,rejectUnauthorized:false,requestCert:true,agent:false};needle.post("https://www.paypal.com/cgi-bin/webscr",c,f,function g(b,c,d){if(!b&&c.statusCode===200){if(d.substring(0,8)==="VERIFIED"){console.log("Verified IPN!");var e=a.body["item_name"];var f=a.body["item_number"];var g=a.body["payment_status"];var h=a.body["mc_gross"];var i=a.body["mc_currency"];var j=a.body["txn_id"];var k=a.body["receiver_email"];var l=a.body["payer_email"];var m=a.body["custom"];if(g=="Completed"){var n;n=new InvoiceModel({sid:m,invoiceid:j,invoicedate:moment(),itemname:e,sum:h});n.save(function(a){if(!a){console.log("[Invoice saved]")}else{console.log(a)}})}if(f=="cityfab2month"&&h=="20.00"&&g=="Completed"){var o=new Date;var p=o.getDate();var q=o.getMonth()+3;var r=o.getFullYear();if(p<10){p="0"+p}if(q<10){q="0"+q}var s=r+"-"+q+"-"+p;User.findByIdAndUpdate({_id:m},{subscriptionstatus:"active",subscriptionends:s},function(a,b){if(!a)return"200";else console.log(a);return"401"})}else if(f=="cityfab6month"&&h=="100.00"&&g=="Completed"){var o=new Date;var p=o.getDate();var q=o.getMonth()+7;var r=o.getFullYear();if(p<10){p="0"+p}if(q<10){q="0"+q}var s=r+"-"+q+"-"+p;User.findByIdAndUpdate({_id:m},{subscriptionstatus:"active",subscriptionends:s},function(a,b){if(!a)return"200";else console.log(a);return"401"})}else if(f=="cityfab1year"&&h=="200.00"&&g=="Completed"){var o=new Date;var p=o.getDate();var q=o.getMonth()+13;var r=o.getFullYear();if(p<10){p="0"+p}if(q<10){q="0"+q}var s=r+"-"+q+"-"+p;User.findByIdAndUpdate({_id:m},{subscriptionstatus:"active",subscriptionends:s},function(a,b){if(!a)return"200";else console.log(a);return"401"})}else if(f=="balance"&&g=="Completed"){User.findByIdAndUpdate({_id:m},$inc({"balance.outbalance":-h}),function(a,b){if(!a)return"200";else console.log(a);return"401"})}}else if(d.substring(0,7)==="INVALID"){console.log("Invalid IPN!".error)}}else{console.log(c.statusCode)}})});app.get("/api/specialists",function(a,b){return User.find({usertype:"specialist"},{},{sort:{created:-1}},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/specialists/active",function(a,b){return User.find({usertype:"specialist",subscriptionstatus:"active"},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/specialists/:id",function(a,b){return User.findById(a.params.id,function(a,c){if(!a){if(c)return b.send(c);else return b.status(404).send("Specialist not found")}else{return console.log(a)}})});app.get("/api/workdates/:id",function(a,b){return workDateModel.find({wdid:a.params.id}).populate("owner").exec(function(a,c){if(a)b.send(a);else b.send(c)})});app.post("/api/specialists",function(a,b){var c;c=new User({password:a.body.password,firstname:a.body.firstname,lastname:a.body.lastname,usertype:"specialist",servicesnum:0,rating:0,address:a.body.address,addresses:a.body.addresses,mood:a.body.mood,aboutme:a.body.aboutme,fbid:a.body.fbid,taxid:a.body.taxid,calltype:a.body.calltype,services:a.body.services,subservices:a.body.subservices,schedule:a.body.schedule,workschedule:a.body.workschedule,profilepic:a.body.profilepic,profilethumb:a.body.profilethumb,background:a.body.background,gallery:a.body.gallery,products:a.body.products,languages:a.body.languages,email:a.body.email,phone:a.body.phone,loc:a.body.loc,currentloc:a.body.currentloc,verified:a.body.verified|false,pushtoken:a.body.pushtoken,googleid:a.body.googleid,fbid:a.body.fbid,availablenow:a.body.availablenow|false,torate:a.body.torate,subscriptionstatus:a.body.subscriptionstatus,subscriptionends:a.body.subscriptionends});if((c.addresses==null||c.addresses.length==0)&&c.address!=null){c.addresses=[];var d=new AddressModel;d.location=c.address;d.alias="Default";d.geolocation=c.loc;c.addresses.push(d)}if(c.balance==null||c.balance==undefined){var e={services:0,cancelations:0,outbalance:0};c.balance=e}c.save(function(a){if(!a){return b.send(c)}else{if(11e3===a.code||11001===a.code){return b.status(401).send("[401]: Duplicate key found - username or email")}else return b.send(a.message)}})});app.post("/api/specialists/availability",function(a,b){User.update({_id:a.body._id},{currentloc:a.body.loc,availablenow:a.body.status},function(a,c){if(!a)b.status(200);else b.status(401).send(a)})});app.post("/api/subscription",function(a,b){return User.findByIdAndUpdate(a.body._id,{subscriptionstatus:a.body.subscriptionstatus,subscriptionends:moment(a.body.subscriptionends)},function(a,c){if(!a)return b.status(200);else return b.status(401).send(a)});return b.status(200)});app.put("/api/specialists/:id",function(a,b){return User.findById(a.params.id,function(c,d){d.fbid=a.body.fbid;d.subservices=a.body.subservices;d.background=a.body.background;d.gallery=a.body.gallery;d.products=a.body.products;d.languages=a.body.languages;d.currentloc=a.body.currentloc;d.verified=a.body.verified;d.mood=a.body.mood;d.taxid=a.body.taxid;d.password=a.body.password;d.firstname=a.body.firstname;d.lastname=a.body.lastname;d.schedule=a.body.schedule;d.workschedule=a.body.workschedule;d.usertype=a.body.usertype;d.calltype=a.body.calltype;d.services=a.body.services;d.profilepic=a.body.profilepic;d.profilethumb=a.body.profilethumb;d.email=a.body.email;d.phone=a.body.phone;d.loc=a.body.loc;d.address=a.body.address;d.addresses=a.body.addresses;d.pushtoken=a.body.pushtoken;d.googleid=a.body.googleid;d.availablenow=a.body.availablenow|false;d.torate=a.body.torate;d.favorites=a.body.favorites;if(d.balance==null||d.balance==undefined){var e={services:0,cancelations:0,outbalance:0};d.balance=e}if(a.body.secret="a21th21_A21"){d.subscriptionstatus=a.body.subscriptionstatus;d.subscriptionends=a.body.subscriptionends}if((d.addresses==null||d.addresses.length==0)&&d.address!=null){var f=new AddressModel;f.location=d.address;f.alias="Default";f.geolocation=d.loc;d.addresses.push(f)}if(d.address!=null&&d.address!=d.addresses[0].location)d.addresses[0].location=d.address;return d.save(function(a){if(!a){return b.send("Done")}else{return b.status(401).send(a.message)}})})});app.get("/api/users",function(a,b){console.log("now");return User.find({usertype:"user"},{},{sort:{created:-1}},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/users/:id",function(a,b){return User.findById(a.params.id,function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.post("/api/users",function(a,b){var c;c=new User({password:a.body.password,firstname:a.body.firstname,lastname:a.body.lastname,usertype:"user",addresses:a.body.addresses,email:a.body.email,phone:a.body.phone,loc:a.body.loc,verified:a.body.verified|false,fbid:a.body.fbid,pushtoken:a.body.pushtoken});c.save(function(a){if(!a){return b.send(c)}else{if(11e3===a.code||11001===a.code){console.log("[401]: Duplicate key found - username or email");return b.status(401).send("[401]: Duplicate key found - username or email")}else return b.send(a)}})});app.put("/api/users/:id",function(a,b){return User.findById(a.params.id,function(c,d){_user.username=a.body.username;_user.password=a.body.password;_user.firstname=a.body.firstname;_user.lastname=a.body.lastname;_user.usertype=a.body.usertype;_user.addresses=a.body.addresses;_user.email=a.body.email;_user.phone=a.body.phone;_user.loc=a.body.loc;_user.pushtoken=a.body.pushtoken;_user.fbid=a.body.fbid;_user.favorites=a.body.favorites;console.log(_user.favorites);console.log(a.body.favorites);return _user.save(function(a){if(!a){console.log("Done.")}else{console.log(a)}return b.send(d)})})});app.get("/api/calendar/schedule/owner/:id",function(a,b){Schedule.findOne({owner:a.params.id},function(a,c){if(!a){b.send(c)}else b.send(a)})});app.post("/api/calendar/schedule",function(a,b){var c=new Schedule({owner:a.body.owner,days:a.body.days,timeblocks:a.body.timeblocks});var d=c.toObject();delete d._id;Schedule.update({owner:a.body.owner},d,{upsert:true},function(a,c){if(!a){b.status(200)}else b.send(a)})});app.get("/api/calendar/:id",function(a,b){workDateModel.find({owner:a.params.id},function(a,c){if(!a){b.send(c)}else b.send(a)})});app.post("/api/calendar/workdate/:id",function(a,b){if(!a.body.wdid)return b.status(404).send("No valid workdate ID found!");var c=new workDateModel({workday:a.body.workday,wdid:a.body.wdid,timeslots:a.body.timeslots,owner:a.params.id});var d=c.toObject();delete d._id;workDateModel.update({wdid:a.body.wdid},d,{upsert:true},function(a,d){if(!a){b.send(c)}else b.send(a)})});app.put("/api/calendar/workdate/:id",function(a,b){return workDateModel.findById(a.params.id,function(c,d){d.workday=a.body.workday;d.wdid=a.body.wdid;d.owner=a.body.owner;d.timeslots=a.body.timeslots;return d.save(function(a){if(!a){console.log("Done.")}else{console.log(a)}return b.status(200).send(d)})})});app.delete("/api/calendar/workdate/:id",function(a,b){workDateModel.findById(a.params.id,function(a,c){return c.remove(function(a){if(!a){console.log("Done.");b.status(200)}else{console.log(a);b.status(501).send(a)}})})});app.get("/api/appointments/:id",function(a,b){return AppointmentsModel.findById(a.params.id,function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/appointments/:id/pending/count",function(a,b){return AppointmentsModel.find({sid:a.params.id,status:"pending"}).count(function(a,c){if(!a){return b.send({count:c})}else{return b.send(a)}})});app.get("/api/appointments/user/:id",function(a,b){return AppointmentsModel.find({uid:a.params.id},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.post("/api/appointments/tokenUpdate/",function(a,b){AppointmentsModel.update({uid:a.body.id},{$set:{utoken:a.body.token}},{multi:true},function(a,c){if(a)return b.send(a)});AppointmentsModel.update({sid:a.body.id},{$set:{stoken:a.body.token}},{multi:true},function(a,c){if(a)return b.send(a)});b.sendStatus(200)});app.get("/api/appointments/specialist/:id",function(a,b){return AppointmentsModel.find({sid:a.params.id},{},{sort:{startdate:1}},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.post("/api/appointments",function(a,b){var c=0;if(a.body.status==null){c=1}var d=new workDateModel({wdid:a.body.timetable[0].wdid,timeslots:a.body.timetable[0].timeslots});var e=ConvertworkDate(d);var f;if(a.body.comment!=undefined)f=a.body.comment;else f="Θα ήθελα να κλείσω ένα ραντεβού.";var g=new CommentModel({name:a.body.uname,comment:f,createdAt:a.body.created});var h=new AppointmentsModel({upic:a.body.upic,uname:a.body.uname,uid:a.body.uid,utoken:a.body.utoken,spic:a.body.spic,sname:a.body.sname,calltype:a.body.calltype,sid:a.body.sid,address:a.body.address,stoken:a.body.stoken,subservicetype:a.body.subservicetype,status:"pending",startdate:e,rated:false,notified:false,requestedon:moment(),distance:a.body.distance,cost:a.body.cost});h.timetable.push(d);h.comments.push(g);User.findById(h.uid,function(a,c){if(!a){if(h.address==null){if(c.addresses!=null&&c.addresses.length>0)h.address=c.addresses[0].location;else h.address=c.address}}else{console.log(a);return b.send(a)}});if(h.address!=null){h.save(function(d){if(!d){if(c==1){var e={page:"AppointmentView",id:h._id};var f={en:a.body.uname+" has requested an appointment.",el:"Ο "+a.body.uname+" σας ζήτησε ένα ραντεβού."};pushUser([a.body.stoken],f,[a.body.sid],e)}return b.send(h)}else{console.log(d);return b.send(d)}})}});var ConvertworkDate=function(a){var b=a.wdid.split("-");var c=b[2]+"-"+("0"+b[0]).slice(-2)+"-"+("0"+b[1]).slice(-2)+"T"+convertTimeBlockToHour(parseInt(a.timeslots[0]));var d=new Date(c);return d};var convertTimeBlockToHour=function(a){var b=48;var c=24*60/b;var d=c*a;var e=Math.floor(d/60);var f=d%60;return("0"+e).slice(-2)+":"+("0"+f).slice(-2)};app.put("/api/appointments/:id",function(a,b){return AppointmentsModel.findById(a.params.id,function(c,d){if(!c){if(d.status=="pending"&&a.body.status=="accepted"){var e={page:"AppointmentView",id:d._id};var f={en:"Your appointment with "+a.body.sname+" has been accepted",el:"Ο "+a.body.sname+" αποδέχθηκε το ραντεβού σας"};pushUser([d.utoken],f,[d.uid],e)}else if(d.status=="pending"&&a.body.status=="rejected"){var f={en:"Your appointment with "+a.body.sname+" has been rejected",el:"Ο "+a.body.sname+" δεν αποδέχθηκε το ραντεβού σας"};var e={page:"AppointmentView",id:d._id};pushUser([d.utoken],f,[d.uid],e)}else if(d.status=="pending"&&a.body.status=="canceled"){var f={en:"The appointment requested by "+a.body.uname+" has been canceled.",el:"Το ραντεβού σας με τον "+a.body.sname+" ακυρώθηκε."};var e={page:"AppointmentView",id:d._id};pushUser([d.stoken],"The appointment requested by "+a.body.uname+" has been canceled.",[d.uid],e)}else if(d.comments.length!=a.body.comments.length){var e={page:"AppointmentView",id:d._id};var f={en:"One of your appointments has been updated.",el:"Ένα από τα ραντεβού σας έχει τροποποιηθεί."};pushUser([d.utoken,d.stoken],f,[d.uid,d.sid],e)}d.status=a.body.status;d.timetable=a.body.timetable;d.comments=a.body.comments;return d.save(function(a){if(!a){console.log("Done.");return b.status(200).send("Appointment saved")}else{console.log(a);return b.send(a)}return b.send(d)})}else{console.log(c);return b.send(c)}})});app.post("/api/push",function(a,b){JSON.stringify(a.body.tokens);pushUser(a.body.tokens,a.body.messages,null,null);return b.status(200).send("Push sent")});var indxer=0;var pushUser=function(a,b,c,d){for(var e=0;e<a.length;e++){console.log("[PUSH] Sending push to token: "+a[e]+" with message: "+JSON.stringify(b))}for(var f in c){indxer++;console.log("Saving in-app notification to: "+c[f]);var g=new Notification({index:indxer,uid:c[f],message:b["en"],localisedMessage:b,data:d,createdAt:moment()});g.markModified("localisedMessage");g.markModified("data");g.save()}var h={headers:{content_type:"application/json"}};var i;if(d!=undefined){i={request:{application:"D7CAA-96160",auth:"oFXcjNA3FanCvVpS0yeC7TkuIlsXSQ5avVmBZ5Nger5A4Se53kBqcfWwJNJouLCGFzAtcjRlTBqNjhOkKVDx",notifications:[{send_date:"now",ignore_user_timezone:true,content:b,devices:a,data:d}]}}}else{i={request:{application:"D7CAA-96160",auth:"oFXcjNA3FanCvVpS0yeC7TkuIlsXSQ5avVmBZ5Nger5A4Se53kBqcfWwJNJouLCGFzAtcjRlTBqNjhOkKVDx",notifications:[{send_date:"now",ignore_user_timezone:true,content:b,devices:a}]}}}needle.post("cp.pushwoosh.com/json/1.3/createMessage",i,{json:true},function(a,b,c){if(!a){console.log("[PUSH] Successful push")}else console.log(a)})};app.post("/api/review",function(a,b){var c=new RateModel({sname:a.body.sname,pic:a.body.pic,sid:a.body.sid,stoken:a.body.stoken,uname:a.body.uname,rating:a.body.rating,review:a.body.review,createdAt:moment()});var d={en:a.body.uname+" has posted a review about your recent service",el:"Ο "+a.body.uname+" σας έκανε review για το πρόσφατο ραντεβού σας"};pushUser([a.body.stoken],a.body.uname+" has posted a review about your recent service",[a.body.sid],null);var e=c.toObject();delete e._id;return User.findById(a.body.sid,function(a,c){if(a){return b.send(a)}else{c.reviews.push(e);c.rating=SimpleRatingAlgorith(c);c.save(function(a){if(a){console.log(a);return b.send(a)}else{console.log("Review Submitted");return b.status(200).send()}});return b.status(200).send()}})});var SimpleRatingAlgorith=function(a){var b=0;var c=a.reviews.length;var d=0;for(var e=0;e<c;e++)if(a.reviews[e].rating==1)d++;return Math.round(d/c*10*10)/10};app.get("/api/search/all",function(a,b){return User.find({},function(a,c){if(!a){return b.send(c)}else{console.log(c);return b.send(a)}})});app.delete("/api/search/all/:id",function(a,b){User.findById(a.params.id,function(a,c){return c.remove(function(a){if(!a){console.log("Done.");b.status(200)}else{console.log(a);b.status(501).send(a)}})})});app.post("/api/search/all/",function(a,b){var c;c=new User({password:a.body.password,firstname:a.body.firstname,lastname:a.body.lastname,usertype:"specialist",addresses:a.body.addresses,mood:a.body.mood,aboutme:a.body.aboutme,fbid:a.body.fbid,services:a.body.services,subservices:a.body.subservices,schedule:a.body.schedule,profilepic:a.body.profilepic,profilethumb:a.body.profilethumb,background:a.body.background,gallery:a.body.gallery,products:a.body.products,languages:a.body.languages,email:a.body.email,phone:a.body.phone,loc:a.body.loc,currentloc:a.body.currentloc,verified:a.body.verified|false,pushtoken:a.body.pushtoken,googleid:a.body.googleid,fbid:a.body.fbid});c.save(function(a){if(!a){return b.send(c)}else{console.log(a);if(11e3===a.code||11001===a.code){return b.status(401).send("[401]: Duplicate key found - username or email")}else return b.send(a)}})});app.put("/api/search/all/:id",function(a,b){return User.findById(a.params.id,function(c,d){console.log(a.body.schedule);d.fbid=a.body.fbid;d.subservices=a.body.subservices;d.background=a.body.background;d.gallery=a.body.gallery;d.products=a.body.products;d.languages=a.body.languages;d.currentloc=a.body.currentloc;d.verified=a.body.verified;d.password=a.body.password;d.firstname=a.body.firstname;d.lastname=a.body.lastname;d.schedule=a.body.schedule;d.usertype=a.body.usertype;d.services=a.body.services;d.profilepic=a.body.profilepic;d.profilethumb=a.body.profilethumb;d.email=a.body.email;d.phone=a.body.phone;d.loc=a.body.loc;d.addresses=a.body.addresses;d.pushtoken=a.body.pushtoken;d.googleid=a.body.googleid;return d.save(function(a){if(!a){console.log("Done");return b.send("Done")}else{console.log(a);return b.send(a)}})})});app.get("/api/search",function(a,b){return User.find({usertype:"specialist"},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});var global=true;app.get("/api/search/global/:state",function(a,b){global=a.params.state;b.send("Cityfab API Global Search set to: "+global)});app.get("/api/search/location/current/:long/:lat/:max",function(a,b){var c=a.params.max;if(global==false){return User.find({usertype:"specialist",subscriptionstatus:"active",currentloc:{$near:{$geometry:{type:"Point",coordinates:[a.params.long,a.params.lat]},$minDistance:1,$maxDistance:c}}},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})}else{return User.find({usertype:"specialist",subscriptionstatus:"active"},{},{},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})}});app.get("/api/v1/search/bylocation/:long/:lat/:max",function(a,b){var c=a.params.max;c=3e4;return User.find({usertype:"specialist",subscriptionstatus:"active",loc:{$near:{$geometry:{type:"Point",coordinates:[a.params.long,a.params.lat]},$minDistance:1,$maxDistance:c}},workschedule:{$exists:true,$not:{$size:0}}}).select("firstname lastname profilepic profilethumb rating services loc currentloc calltype availablenow").exec(function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/v1/search/bycurrentlocation/:long/:lat/:max",function(a,b){var c=a.params.max;c=3e4;return User.find({usertype:"specialist",subscriptionstatus:"active",currentloc:{$near:{$geometry:{type:"Point",coordinates:[a.params.long,a.params.lat]},$minDistance:1,$maxDistance:c}},availablenow:"true"}).select("firstname lastname profilepic profilethumb rating services loc currentloc calltype availablenow").exec(function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/v1/search/:byname/:long/:lat/:max",function(a,b){var c=a.params.max;c=3e4;var d=a.params.byname;return User.find({usertype:"specialist",subscriptionstatus:"active",$or:[{lastname:new RegExp(d,"i")},{firstname:new RegExp(d,"i")}]}).select("firstname lastname profilepic profilethumb rating services currentloc calltype availablenow").exec(function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});app.get("/api/search/location/:long/:lat/:max",function(a,b){return User.find({usertype:"specialist",loc:{$near:{$geometry:{type:"Point",coordinates:[a.params.long,a.params.lat]},$minDistance:0,$maxDistance:a.params.max}}},function(a,c){if(!a){return b.send(c)}else{return console.log(a)}})});var nodemailer=require("nodemailer");var smtpTransport=require("nodemailer-smtp-transport");var transporter=nodemailer.createTransport(smtpTransport({host:"http://bedbugstudiocom.ipage.com",secure:false,port:587,auth:{user:"sender@bedbugstudio.com",pass:"a21th21_A21"},tls:{rejectUnauthorized:false}}));app.post("/api/email",function(a,b){User.findOne({email:a.body.email},function(a,c){if(!a){if(c!=null){console.log("[info] User found");var d={from:"sender@bedbugstudio.com",to:c.email,subject:"Cityfab - Password Recovery Information ",text:"Your password for cityfab is "+c.password+"."};transporter.sendMail(d,function(a,b){if(a){console.log(a)}else{console.log("Message sent: "+b.response)}});return b.status(200).send("You should receive an email containing your information shortly")}else{console.log("[info] User not found");return b.status(401).send("Email/User not found")}}else{console.log(error.message);return b.send(a)}})});app.get("/api/appsettings",function(a,b){var c={token:"el9hqee",background_prefix:"http://el9hqee.cloudimg.io/s/crop/420x200/",icon_prefix:"http://el9hqee.cloudimg.io/s/crop/300x300/",icon_thumb_prefix:"http://el9hqee.cloudimg.io/s/crop/100x100/",gallery_prefix:"http://el9hqee.cloudimg.io/s/resizenp/400x400/"};return b.send(c)});var SettingsSchema=mongoose.Schema;var Settings=new SettingsSchema({server:{type:String,required:true},imagepath:{type:String,required:true},sockets:{type:String,required:true},polling:{type:String,required:true}});var SettingsModel=mongoose.model("Settings",Settings);app.get("/api/settings",function(a,b){return SettingsModel.findOne({},function(a,c){if(!a){console.log(c);return b.send(c)}else{console.log(a);return b.send(a)}})});app.put("/api/settings/:id",function(a,b){return SettingsModel.findById(a.params.id,function(c,d){d.server=a.body.server;d.imagepath=a.body.imagepath;d.sockets=a.body.sockets;d.polling=a.body.polling;return d.save(function(a){if(!a){console.log("Done.")}else{console.log(a)}return b.send(d)})})});app.post("/api/settings/",function(a,b){var c=new SettingsModel({_id:a.body._id,server:a.body.server,imagepath:a.body.imagepath,sockets:a.body.sockets,polling:a.body.polling});c.update({_id:_id},{$setOnInsert:c},{upsert:true},function(a,c){if(!a){return b.send(c)}else{return b.send(a)}})});app.options("/api/upload",function(a,b){console.log("OPTIONS:"+flow);if(ACCESS_CONTROLL_ALLOW_ORIGIN){b.header("Access-Control-Allow-Origin","*")}b.status(200).send()});app.get("/api/download/:identifier",function(a,b){flow.write(a.params.identifier,b)});app.get("/api/upload/",function(a,b){console.log("Identifier:"+a.params.identifier);flow.get(a,function(a,c,d,e){if(ACCESS_CONTROLL_ALLOW_ORIGIN){b.header("Access-Control-Allow-Origin","*")}if(a=="found"){a=200}else{a=404}b.status(a).send()})});app.post("/api/upload",multipartMiddleware,function(a,b){flow.post(a,function(a,c,d,e,f,g){console.log("POST",a,d,e,f,g);if(a=="done"&&f>g){console.log("now saving to ./tmp/"+c);var h=fs.createWriteStream("./img/"+c);h.on("finish",function(){b.status(200).send()});flow.write(e,h,{onDone:flow.clean(e)})}})});var server=app.listen(4242,function(){var a=server.address().address;var b=server.address().port;console.log("Cityfab API v1.0.0 started listening.")});